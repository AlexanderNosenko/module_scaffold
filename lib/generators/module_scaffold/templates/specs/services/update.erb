require 'rails_helper'

describe <%= @services_helper.full_class_name('update') %> do
  subject { described_class.new(<%= @services_helper.resource_name %>, ActionController::Parameters.new(params)).call }
  let_it_be(:<%= @services_helper.resource_name %>) { create(:<%= @services_helper.resource_name %>) }
  let(:params) do
    {
      <%= @services_helper.resource_name %>: {
        <%= @services_specs_helper.tested_attributes_formatted_str %>
      }
    }
  end

  describe '#call' do
    context 'with valid params' do
      it 'doesnt create new <%= @services_helper.resource_name %>' do
        expect { subject }.to change { <%= @services_helper.module_full_name %>.count }.by(0)
      end

      it 'updates <%= @services_helper.resource_name %> with correct attributes' do
        service = subject

        expect(service.success?).to eq true
        result = service.result
        expect(result).to be_a <%= @services_helper.module_full_name %>

        params[:<%= @services_helper.resource_name %>].each do |key, value|
          expect(result[key]).to eq value
        end
      end
    end

    context 'with invalid params' do
      let(:params) do
        {
          <%= @services_helper.resource_name %>: {
            <%= @policy_helper.permitted_attributes.map do |attr|
              "#{attr}: nil"
            end.join(",\n") %>
          }
        }
      end

      it 'returns invalid record as error attribute' do
        service = subject

        expect(service.success?).to eq false
        expect(service.result).to eq nil
        expect(service.error).to be_a <%= @services_helper.module_full_name %>
        expect(service.error.valid?).to eq false
      end
    end
  end
end
